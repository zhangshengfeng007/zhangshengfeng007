C51 COMPILER V9.60.7.0   SYSTEM                                                            04/16/2024 15:41:18 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE SYSTEM
OBJECT MODULE PLACED IN .\Objects\system.obj
COMPILER INVOKED BY: F:\tool_start\keil_c51\C51\BIN\C51.EXE ..\App\system.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\App\inc;.
                    -.\Driver\inc) DEBUG OBJECTEXTEND PRINT(.\Listings\system.lst) TABS(2) OBJECT(.\Objects\system.obj)

line level    source

   1          #include "system.h"
   2          
   3          //0:输入模式 1:输出模式
   4          #define   P00M    0
   5          #define   P01M    0
   6          #define   P02M    0   //T_DATA
   7          #define   P03M    1   //T_CLOCK
   8          #define   P04M    1   //LEDB
   9          #define   P05M    1   //SDIO
  10          #define   P06M    1   //SCKO
  11          #define   P07M    1   //LCKO
  12          #define   P10M    1   //IG_CTR
  13          #define   P11M    1   //DISCHR
  14          #define   P12M    0
  15          #define   P13M    0
  16          #define   P14M    0   //ROTARY
  17          #define   P15M    0   //ROTARY
  18          #define   P16M    0   //ROTARY
  19          #define   P17M    0   //VB1
  20          #define   P20M    0   //AD_NTC
  21          #define   P21M    0
  22          #define   P22M    0   //AD_VB2
  23          #define   P23M    0   //FAN_AD
  24          #define   P24M    0   //PULESE
  25          #define   P25M    1   //FAN
  26          
  27          
  28          void GPIO_Init(void)
  29          {
  30   1        P0=0;P1=0;P2=0;
  31   1        P0M=0;P1M=0;P2M=0;
  32   1        //输入输出模式
  33   1        P0M = P00M|(P01M<<1)|(P02M<<2)|(P03M<<3)|(P04M<<4)|(P05M<<5)|(P06M<<6)|(P07M<<7);
  34   1        P1M = P10M|(P11M<<1)|(P12M<<2)|(P13M<<3)|(P14M<<4)|(P15M<<5)|(P16M<<6)|(P17M<<7);
  35   1        P2M |= P20M|(P22M<<2)|(P23M<<3)|(P24M<<4)|(P25M<<5);
  36   1        
  37   1        P0UR = 0;P1UR = 0;P2UR = 0;
  38   1        //PWM
  39   1        P2UR |= 0x30;
  40   1        //KEY
  41   1        P1UR |= 0x04;
  42   1        
  43   1        P0UR |= 0x04;
  44   1        //ADC
  45   1        P2UR &= ~0x0d;
  46   1        P1UR &= ~0x80;
  47   1        //DISPLAY
  48   1        SCK = 0;
  49   1        RCK = 0;
  50   1        LEDB = 1;
  51   1      }
  52          
  53          
  54          void SYSCLK_Init(void)
C51 COMPILER V9.60.7.0   SYSTEM                                                            04/16/2024 15:41:18 PAGE 2   

  55          {
  56   1        CLKSEL |= 0x07;   //Fcpu = Fosc/1
  57   1        CLKCMD = 0x69;
  58   1      }
  59          
  60          /***********************************************************************************/
  61          static idata TASK tasks[ARRAY_SIZE];
  62          TIM_Period_T TIM_Period;
  63          
  64          static TASK Task_Register(uint8_t FLAGS, void(*HANDLE)(void))
  65          {
  66   1        TASK task;
  67   1        task.flags = FLAGS;
  68   1        task.handle = HANDLE;
  69   1        return (task);
  70   1      }
  71          
  72          void Task_Handle(void)// 任务执行函数，按任务的创建顺序执行任务；                     
  73          {
  74   1        static uint8_t taskindex;
  75   1        for(taskindex=0; taskindex<ARRAY_SIZE; taskindex++)
  76   1        {
  77   2          if (tasks[taskindex].flags==1)                    // 查询任务时间是否到
  78   2          {
  79   3            (*tasks[taskindex].handle)();                  // 执行任务
  80   3            tasks[taskindex].flags = 0;                    // 消除任务标记位
  81   3          }
  82   2        }
  83   1      }
  84          
  85          void System_Run(void)
  86          {
  87   1        Task_Handle();
  88   1        WDTR = 0x5a;
  89   1      }
  90          
  91          void Task_Init(void)
  92          {
  93   1        tasks[0] = Task_Register(0, Work_Handler);          /* 打光 */
  94   1        tasks[1] = Task_Register(0, Charge_Handler);        /* 容充 */
  95   1        tasks[2] = Task_Register(0, Key_Handler);         /* 按I呙 */
  96   1        tasks[3] = Task_Register(0, Rotary_Handler);        /* 旋o判 */
  97   1        tasks[4] = Task_Register(0, Touch_Key_Handler);       /* |摸按I呙 */
  98   1        tasks[5] = Task_Register(0, VDD_Test_Handler);        /* 供定zy */
  99   1        tasks[6] = Task_Register(0, Fan_Handler);         /* L扇任 */
 100   1        tasks[7] = Task_Register(0, NTC_Handler);         /* 囟缶任 */
 101   1        tasks[8] = Task_Register(0, Error_Det_Handler);       /* e`缶任 */
 102   1        tasks[9] = Task_Register(0, Display_Handler);       /* @示任 */
 103   1        tasks[10] = Task_Register(0, Sleep_Handler);        /* 休眠任 */
 104   1        tasks[11] = Task_Register(0, Touch_Handler);        /* |摸任 */
 105   1        tasks[12] = Task_Register(0, Burnin_Handler);       /* 老化模式 */
 106   1      }
 107          
 108          void Task_Roll(void)
 109          {
 110   1        tasks[9].flags = 1;
 111   1        switch(TIM_Period.systick)
 112   1        {
 113   2          case 1:
 114   2          //  tasks[9].flags = 1;
 115   2          case 10:
 116   2            tasks[0].flags = 1;//Work_Handler
C51 COMPILER V9.60.7.0   SYSTEM                                                            04/16/2024 15:41:18 PAGE 3   

 117   2            tasks[1].flags = 1;//Charge_Handler
 118   2            tasks[2].flags = 1;//Key_Handler
 119   2            tasks[3].flags = 1;//Rotary_Handler
 120   2            tasks[4].flags = 1;//Touch_Key_Handler
 121   2            tasks[11].flags = 1;//Touch_Handler
 122   2          break;
 123   2          case 5:
 124   2            tasks[5].flags = 1;//VDD_Test_Handler
 125   2          break;
 126   2          case 15:
 127   2            tasks[6].flags = 1;//Fan_Handler
 128   2            tasks[7].flags = 1;//NTC_Handler
 129   2            tasks[8].flags = 1;//Error_Det_Handler
 130   2          //  tasks[9].flags = 1;//Display_Handler
 131   2            tasks[10].flags = 1;//Sleep_Handler
 132   2            tasks[12].flags = 1;//Burnin_Handler
 133   2          break;
 134   2          default:break;
 135   2        }
 136   1      }
 137          
 138          idata uint8_t SupplyTestFinishedFlag = false;
 139          void System_Init(void)
 140          {
 141   1        //Delay500ms();
 142   1        TIMER0_Configuration();
 143   1        TIMER1_Configuration();
 144   1        TIMER2_Configuration();
 145   1        
 146   1        /* T2 L3 T0 L2 T1 L1 */
 147   1        IP1 |= 0x22;
 148   1        IP0 |= 0x28;
 149   1        
 150   1        RELEASE_400V_EN();
 151   1        ADCInit();
 152   1        Pwm_Init();
 153   1        Key_init();
 154   1        //UartInit();
 155   1        
 156   1        Touch_Key_Init();
 157   1        
 158   1        Work_Init();
 159   1        Charge_Init();
 160   1        Fan_Init();
 161   1        
 162   1        
 163   1      //  NTC_Init();
 164   1        Burnin_init();
 165   1        Display_init();
 166   1        
 167   1        Task_Init();
 168   1        
 169   1        SupplyTestFinishedFlag = true;
 170   1      }
 171          
 172          //void Task_DeInit(void)
 173          //{
 174          //  uint8_t i;
 175          //  
 176          //  for(i=0;i<ARRAY_SIZE;i++)
 177          //    tasks[i].flags = 0;
 178          //}
C51 COMPILER V9.60.7.0   SYSTEM                                                            04/16/2024 15:41:18 PAGE 4   

 179          
 180          
 181          
 182          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    545    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      3       4
   IDATA SIZE       =     53    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
